name: Create Story

on:
  # Manual trigger via GitHub UI
  workflow_dispatch:
    inputs:
      story_id:
        description: 'Story ID (e.g., 3-3-contamination-prevention-system)'
        required: true
        type: string
      epic:
        description: 'Epic number (e.g., 3)'
        required: false
        default: '3'
        type: string
      title:
        description: 'Story title (auto-generated from ID if not provided)'
        required: false
        type: string
      description:
        description: 'Story description (auto-generated if not provided)'
        required: false
        type: string
      acceptance_criteria:
        description: 'Acceptance criteria (JSON array, auto-generated if not provided)'
        required: false
        type: string

  # Can be called from other workflows
  workflow_call:
    inputs:
      story_id:
        type: string
        required: true
      epic:
        type: string
        required: false
        default: '3'
      title:
        type: string
        required: false
      description:
        type: string
        required: false
      acceptance_criteria:
        type: string
        required: false

jobs:
  create-story:
    name: Create Story
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install tsx globally
        run: npm install -g tsx typescript

      - name: Create story file
        run: |
          STORY_ID="${{ github.event.inputs.story_id || inputs.story_id }}"
          EPIC="${{ github.event.inputs.epic || inputs.epic }}"
          TITLE="${{ github.event.inputs.title || inputs.title }}"
          DESCRIPTION="${{ github.event.inputs.description || inputs.description }}"
          ACCEPTANCE_CRITERIA="${{ github.event.inputs.acceptance_criteria || inputs.acceptance_criteria }}"

          echo "Creating story with:"
          echo "  Story ID: $STORY_ID"
          echo "  Epic: $EPIC"
          echo "  Title: $TITLE"
          echo "  Description: $DESCRIPTION"
          echo "  Acceptance Criteria: $ACCEPTANCE_CRITERIA"

          # Check if story already exists
          STORY_FILE="test-platform/docs/stories/${STORY_ID}.md"
          if [ -f "$STORY_FILE" ]; then
            echo "âš ï¸ Story file already exists: $STORY_FILE"
            echo "Skipping creation to avoid overwrite."
            exit 0
          fi

          # Create story using tsx script
          tsx .github/scripts/create-story.ts \
            --story-id "$STORY_ID" \
            --epic "$EPIC" \
            --title "$TITLE" \
            --description "$DESCRIPTION" \
            --acceptance-criteria "$ACCEPTANCE_CRITERIA"

      - name: Validate story file
        run: |
          STORY_ID="${{ github.event.inputs.story_id || inputs.story_id }}"
          STORY_FILE="test-platform/docs/stories/${STORY_ID}.md"

          if [ -f "$STORY_FILE" ]; then
            echo "âœ… Story file created successfully: $STORY_FILE"
            
            # Validate story structure
            if grep -q "# Story" "$STORY_FILE" && \
               grep -q "## Acceptance Criteria" "$STORY_FILE" && \
               grep -q "## Tasks / Subtasks" "$STORY_FILE"; then
              echo "âœ… Story structure validation passed"
            else
              echo "âŒ Story structure validation failed"
              exit 1
            fi
          else
            echo "âŒ Story file was not created"
            exit 1
          fi

      - name: Update epic status
        run: |
          STORY_ID="${{ github.event.inputs.story_id || inputs.story_id }}"
          EPIC="${{ github.event.inputs.epic || inputs.epic }}"

          # Update epic status file if it exists
          EPIC_STATUS_FILE="test-platform/docs/bmm-workflow-status.yaml"
          if [ -f "$EPIC_STATUS_FILE" ]; then
            echo "Updating epic status for Epic $EPIC, Story $STORY_ID"
            # Add story status update logic here
            echo "Story $STORY_ID marked as ready-for-dev"
          fi

      - name: Create pull request
        if: github.event_name == 'workflow_dispatch'
        uses: peter-evans/create-pull-request@v5
        with:
          title: 'Add Story ${{ github.event.inputs.story_id || inputs.story_id }}'
          body: |
            ## ðŸŽ¯ New Story Created

            **Story ID:** `${{ github.event.inputs.story_id || inputs.story_id }}`
            **Epic:** `${{ github.event.inputs.epic || inputs.epic }}`

            This PR was automatically generated by the create-story workflow.

            ### ðŸ“‹ Story Details

            The story file has been created at `test-platform/docs/stories/${{ github.event.inputs.story_id || inputs.story_id }}.md`

            ### âœ… Next Steps

            1. Review the generated story content
            2. Verify acceptance criteria and tasks
            3. Update epic status if needed
            4. Merge to include in development backlog

            ---

            ðŸ¤– *Generated by create-story workflow*
          branch: 'story/${{ github.event.inputs.story_id || inputs.story_id }}'
          delete-branch: true
          labels: |
            story
            epic-${{ github.event.inputs.epic || inputs.epic }}

      - name: Summary
        run: |
          STORY_ID="${{ github.event.inputs.story_id || inputs.story_id }}"
          echo "### ðŸŽ‰ Story Creation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Story ID:** \`$STORY_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "**File Location:** \`test-platform/docs/stories/$STORY_ID.md\`" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Ready for development" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“– **Story Content:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Display story preview
          STORY_FILE="test-platform/docs/stories/$STORY_ID.md"
          if [ -f "$STORY_FILE" ]; then
            # Extract key sections
            echo "**Title:** $(grep '^# Story' "$STORY_FILE" | sed 's/# Story //')" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Description:**" >> $GITHUB_STEP_SUMMARY
            grep -A 3 "As a" "$STORY_FILE" | head -4 >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Acceptance Criteria:** $(grep -c "^\d\+\." "$STORY_FILE") items" >> $GITHUB_STEP_SUMMARY
            echo "**Tasks:** $(grep -c "^\- \[ \]" "$STORY_FILE") subtasks" >> $GITHUB_STEP_SUMMARY
          fi
