# Story 5.9c: API Reference Documentation

**Epic**: Epic 5 - Autonomous Development Orchestration  
**Category**: Documentation  
**Priority**: MVP Critical  
**Status**: Draft

## Acceptance Criteria

- [ ] Complete REST API reference documentation generated from OpenAPI spec
- [ ] All endpoints documented with request/response examples
- [ ] Authentication and authorization flows documented
- [ ] Error response codes and handling documented
- [ ] Rate limiting and pagination documented
- [ ] SDK documentation for TypeScript/JavaScript
- [ ] Interactive API explorer (Swagger UI) deployed
- [ ] Code examples in multiple languages (TypeScript, Python, curl)
- [ ] WebSocket/SSE event streaming documentation
- [ ] API versioning and deprecation policy documented

## Technical Context

### API Documentation Requirements

Based on Epic 5.9c requirements and existing API architecture:

```typescript
// API Documentation Structure
interface APIDocumentation {
  openapi: string; // OpenAPI 3.1 spec
  info: {
    title: string;
    version: string;
    description: string;
    contact: ContactInfo;
    license: LicenseInfo;
  };
  servers: ServerInfo[];
  paths: Record<string, PathItem>;
  components: {
    schemas: Record<string, Schema>;
    responses: Record<string, Response>;
    parameters: Record<string, Parameter>;
    examples: Record<string, Example>;
  };
  security: SecurityRequirement[];
  tags: Tag[];
}
```

### Core API Endpoints

From architecture.md and existing API specifications:

```yaml
# Main API Categories
issues:
  - GET    /api/v1/issues
  - POST   /api/v1/issues
  - GET    /api/v1/issues/:issueId
  - PATCH  /api/v1/issues/:issueId
  - DELETE /api/v1/issues/:issueId
  - GET    /api/v1/issues/:issueId/events
  - POST   /api/v1/issues/:issueId/assign
  - POST   /api/v1/issues/:issueId/start
  - POST   /api/v1/issues/:issueId/pause
  - POST   /api/v1/issues/:issueId/cancel

workflows:
  - GET    /api/v1/workflows
  - GET    /api/v1/workflows/:workflowId
  - GET    /api/v1/workflows/:workflowId/steps
  - POST   /api/v1/workflows/:workflowId/steps/:stepId/retry

events:
  - GET    /api/v1/events
  - GET    /api/v1/events/stream # SSE
  - GET    /api/v1/events/:eventId

providers:
  - GET    /api/v1/providers
  - GET    /api/v1/providers/:providerName
  - POST   /api/v1/providers/:providerName/test
  - GET    /api/v1/providers/:providerName/capabilities

platforms:
  - GET    /api/v1/platforms
  - GET    /api/v1/platforms/:platformName
  - POST   /api/v1/platforms/:platformName/test
  - GET    /api/v1/platforms/:platformName/repositories

plugins:
  - GET    /api/v1/plugins
  - POST   /api/v1/plugins/:pluginName/install
  - DELETE /api/v1/plugins/:pluginName/uninstall
  - GET    /api/v1/plugins/:pluginName/config
  - PATCH  /api/v1/plugins/:pluginName/config

system:
  - GET    /api/v1/health
  - GET    /api/v1/metrics
  - GET    /api/v1/version
  - GET    /api/v1/config
```

### Authentication Documentation

```typescript
// Authentication Flows
interface AuthDocumentation {
  // Bearer Token (JWT)
  bearerAuth: {
    type: 'http';
    scheme: 'bearer';
    bearerFormat: 'JWT';
    description: 'JWT token for API authentication';
  };

  // API Key
  apiKeyAuth: {
    type: 'apiKey';
    in: 'header';
    name: 'X-API-Key';
    description: 'API key for service-to-service authentication';
  };

  // OAuth2
  oauth2: {
    type: 'oauth2';
    flows: {
      authorizationCode: {
        authorizationUrl: '/oauth/authorize';
        tokenUrl: '/oauth/token';
        scopes: {
          'read:issues': 'Read issues and workflows';
          'write:issues': 'Create and modify issues';
          'admin:system': 'System administration';
        };
      };
    };
  };
}
```

## Implementation Tasks

### 1. OpenAPI Specification Generation

```typescript
// packages/api/src/openapi-generator.ts
import { FastifyInstance } from 'fastify';
import { generateSchema } from '@fastify/swagger';

export class OpenAPIGenerator {
  constructor(private fastify: FastifyInstance) {}

  async generateSpec(): Promise<object> {
    const schema = await generateSchema(this.fastify, {
      openapi: {
        openapi: '3.1.0',
        info: {
          title: 'Tamma API',
          version: '1.0.0',
          description: 'AI-powered autonomous development orchestration platform',
          contact: {
            name: 'Tamma Team',
            email: 'support@tamma.dev',
            url: 'https://tamma.dev/support',
          },
          license: {
            name: 'MIT',
            url: 'https://github.com/meywd/tamma/blob/main/LICENSE',
          },
        },
        servers: [
          {
            url: 'https://api.tamma.dev',
            description: 'Production server',
          },
          {
            url: 'https://staging-api.tamma.dev',
            description: 'Staging server',
          },
          {
            url: 'http://localhost:3000',
            description: 'Development server',
          },
        ],
        tags: [
          { name: 'issues', description: 'Issue management' },
          { name: 'workflows', description: 'Workflow orchestration' },
          { name: 'events', description: 'Event streaming' },
          { name: 'providers', description: 'AI provider management' },
          { name: 'platforms', description: 'Git platform management' },
          { name: 'plugins', description: 'Plugin management' },
          { name: 'system', description: 'System information' },
        ],
      },
    });

    // Add custom schemas and examples
    this.enrichWithExamples(schema);
    this.addSecuritySchemes(schema);

    return schema;
  }

  private enrichWithExamples(schema: any): void {
    // Add request/response examples for major endpoints
    schema.components.examples = {
      CreateIssueRequest: {
        summary: 'Create a new issue',
        value: {
          title: 'Add user authentication feature',
          description: 'Implement OAuth2 authentication with GitHub and GitLab',
          priority: 'high',
          labels: ['feature', 'authentication'],
          assignee: 'developer-username',
        },
      },
      IssueResponse: {
        summary: 'Issue details',
        value: {
          id: '550e8400-e29b-41d4-a716-446655440000',
          title: 'Add user authentication feature',
          description: 'Implement OAuth2 authentication with GitHub and GitLab',
          status: 'in_progress',
          priority: 'high',
          labels: ['feature', 'authentication'],
          assignee: 'developer-username',
          createdAt: '2025-01-15T10:30:00.000Z',
          updatedAt: '2025-01-15T14:45:00.000Z',
        },
      },
    };
  }

  private addSecuritySchemes(schema: any): void {
    schema.components.securitySchemes = {
      bearerAuth: {
        type: 'http',
        scheme: 'bearer',
        bearerFormat: 'JWT',
        description: 'JWT token obtained from /oauth/token',
      },
      apiKeyAuth: {
        type: 'apiKey',
        in: 'header',
        name: 'X-API-Key',
        description: 'API key for service-to-service authentication',
      },
    };
  }
}
```

### 2. Interactive API Documentation

```typescript
// packages/api/src/swagger-ui.ts
import fastifySwagger from '@fastify/swagger';
import fastifySwaggerUI from '@fastify/swagger-ui';

export class SwaggerDocumentation {
  static async register(fastify: FastifyInstance): Promise<void> {
    await fastify.register(fastifySwagger, {
      openapi: {
        openapi: '3.1.0',
        info: {
          title: 'Tamma API',
          version: '1.0.0',
          description: 'AI-powered autonomous development orchestration platform',
        },
      },
    });

    await fastify.register(fastifySwaggerUI, {
      routePrefix: '/docs',
      uiConfig: {
        docExpansion: 'list',
        deepLinking: true,
      },
      uiHooks: {
        onRequest: function (request, reply, next) {
          next();
        },
        preHandler: function (request, reply, next) {
          next();
        },
      },
      staticCSP: true,
      transformStaticCSP: (header) => header,
      transformSpecification: (swaggerObject, request, reply) => {
        return swaggerObject;
      },
      transformSpecificationClone: true,
    });

    // Serve OpenAPI spec
    fastify.get('/docs/json', async (request, reply) => {
      return reply.send(fastify.swagger());
    });
  }
}
```

### 3. Code Examples Generator

```typescript
// packages/api/src/code-examples.ts
export class CodeExamplesGenerator {
  generateExamples(endpoint: string, method: string): Record<string, string> {
    const examples: Record<string, string> = {};

    // cURL example
    examples.curl = this.generateCurlExample(endpoint, method);

    // TypeScript example
    examples.typescript = this.generateTypeScriptExample(endpoint, method);

    // Python example
    examples.python = this.generatePythonExample(endpoint, method);

    // JavaScript example
    examples.javascript = this.generateJavaScriptExample(endpoint, method);

    return examples;
  }

  private generateCurlExample(endpoint: string, method: string): string {
    const baseUrl = 'https://api.tamma.dev';
    const headers = '-H "Content-Type: application/json" -H "Authorization: Bearer YOUR_JWT_TOKEN"';

    switch (method) {
      case 'GET':
        return `curl -X GET "${baseUrl}${endpoint}" ${headers}`;
      case 'POST':
        return `curl -X POST "${baseUrl}${endpoint}" ${headers} -d '{"key": "value"}'`;
      case 'PATCH':
        return `curl -X PATCH "${baseUrl}${endpoint}" ${headers} -d '{"key": "value"}'`;
      case 'DELETE':
        return `curl -X DELETE "${baseUrl}${endpoint}" ${headers}`;
      default:
        return `curl -X ${method} "${baseUrl}${endpoint}" ${headers}`;
    }
  }

  private generateTypeScriptExample(endpoint: string, method: string): string {
    return `import { TammaAPI } from '@tamma/api-client';

const client = new TammaAPI({
  baseURL: 'https://api.tamma.dev',
  apiKey: 'YOUR_API_KEY'
});

try {
  const result = await client.${method.toLowerCase()}('${endpoint}');
  console.log(result);
} catch (error) {
  console.error('API Error:', error);
}`;
  }

  private generatePythonExample(endpoint: string, method: string): string {
    return `import requests
import json

base_url = 'https://api.tamma.dev'
headers = {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer YOUR_JWT_TOKEN'
}

try:
    response = requests.${method.toLowerCase()}(
        f'{base_url}{endpoint}',
        headers=headers,
        json={'key': 'value'}
    )
    response.raise_for_status()
    print(response.json())
except requests.exceptions.RequestException as error:
    print(f'API Error: {error}')`;
  }

  private generateJavaScriptExample(endpoint: string, method: string): string {
    return `const fetch = require('node-fetch');

const baseURL = 'https://api.tamma.dev';
const headers = {
  'Content-Type': 'application/json',
  'Authorization': 'Bearer YOUR_JWT_TOKEN'
};

async function makeRequest() {
  try {
    const response = await fetch(\`\${baseURL}${endpoint}\`, {
      method: '${method.toUpperCase()}',
      headers,
      body: JSON.stringify({ key: 'value' })
    });
    
    const data = await response.json();
    console.log(data);
  } catch (error) {
    console.error('API Error:', error);
  }

makeRequest();`;
  }
}
```

### 4. SDK Documentation

```typescript
// packages/api-client/README.md
# Tamma API Client (TypeScript/JavaScript)

Official TypeScript/JavaScript client for the Tamma API.

## Installation

\`\`\`bash
npm install @tamma/api-client
\`\`\`

## Quick Start

\`\`\`typescript
import { TammaAPI } from '@tamma/api-client';

// Initialize client
const client = new TammaAPI({
  baseURL: 'https://api.tamma.dev',
  apiKey: process.env.TAMMA_API_KEY
});

// Create an issue
const issue = await client.issues.create({
  title: 'Add new feature',
  description: 'Feature description',
  priority: 'high'
});

// Start workflow
const workflow = await client.workflows.start(issue.id);
\`\`\`

## Authentication

The client supports multiple authentication methods:

### API Key (Recommended)
\`\`\`typescript
const client = new TammaAPI({
  apiKey: 'your-api-key'
});
\`\`\`

### JWT Token
\`\`\`typescript
const client = new TammaAPI({
  token: 'your-jwt-token'
});
\`\`\`

### OAuth2
\`\`\`typescript
const client = new TammaAPI({
  oauth2: {
    clientId: 'your-client-id',
    clientSecret: 'your-client-secret'
  }
});
\`\`\`

## Error Handling

\`\`\`typescript
try {
  const result = await client.issues.get('issue-id');
} catch (error) {
  if (error instanceof TammaAPIError) {
    console.error('API Error:', error.message);
    console.error('Status:', error.status);
    console.error('Code:', error.code);
  }
}
\`\`\`

## Pagination

\`\`\`typescript
// List with pagination
let page = 1;
let hasMore = true;

while (hasMore) {
  const response = await client.issues.list({ page, limit: 50 });

  // Process issues
  response.data.forEach(issue => {
    console.log(issue.title);
  });

  hasMore = response.hasMore;
  page++;
}
\`\`\`

## Real-time Events

\`\`\`typescript
// Subscribe to issue events
const eventStream = client.events.stream({
  filter: { issueId: 'issue-id' }
});

eventStream.on('ISSUE.UPDATED', (event) => {
  console.log('Issue updated:', event.data);
});

eventStream.on('WORKFLOW.COMPLETED', (event) => {
  console.log('Workflow completed:', event.data);
});
\`\`\`
```

### 5. Error Documentation

```typescript
// Error Response Documentation
interface ErrorDocumentation {
  // Standard Error Format
  error: {
    code: string; // 'ISSUE_NOT_FOUND'
    message: string; // 'Issue with ID xxx not found'
    details?: any; // Additional error context
    timestamp: string; // ISO 8601 timestamp
    requestId: string; // Request tracking ID
  };

  // HTTP Status Codes
  statusCodes: {
    400: 'Bad Request - Invalid input data';
    401: 'Unauthorized - Authentication required';
    403: 'Forbidden - Insufficient permissions';
    404: 'Not Found - Resource not found';
    409: 'Conflict - Resource conflict';
    422: 'Unprocessable Entity - Validation failed';
    429: 'Too Many Requests - Rate limit exceeded';
    500: 'Internal Server Error - Server error';
    502: 'Bad Gateway - Upstream service error';
    503: 'Service Unavailable - Service temporarily unavailable';
  };

  // Error Codes
  errorCodes: {
    // Issue errors
    ISSUE_NOT_FOUND: 'Issue not found';
    ISSUE_ALREADY_ASSIGNED: 'Issue already assigned to another workflow';
    ISSUE_VALIDATION_FAILED: 'Issue data validation failed';

    // Workflow errors
    WORKFLOW_NOT_FOUND: 'Workflow not found';
    WORKFLOW_ALREADY_RUNNING: 'Workflow already running';
    WORKFLOW_STEP_FAILED: 'Workflow step execution failed';

    // Provider errors
    PROVIDER_NOT_AVAILABLE: 'AI provider not available';
    PROVIDER_QUOTA_EXCEEDED: 'Provider quota exceeded';
    PROVIDER_AUTHENTICATION_FAILED: 'Provider authentication failed';

    // Platform errors
    PLATFORM_NOT_CONFIGURED: 'Git platform not configured';
    PLATFORM_API_ERROR: 'Git platform API error';
    PLATFORM_RATE_LIMITED: 'Git platform rate limit exceeded';

    // System errors
    RATE_LIMIT_EXCEEDED: 'API rate limit exceeded';
    MAINTENANCE_MODE: 'System under maintenance';
    INTERNAL_ERROR: 'Internal server error';
  };
}
```

## Testing Strategy

### 1. Documentation Testing

```typescript
// packages/api/test/documentation.test.ts
describe('API Documentation', () => {
  test('OpenAPI spec is valid', async () => {
    const generator = new OpenAPIGenerator(fastify);
    const spec = await generator.generateSpec();

    // Validate against OpenAPI schema
    await expect(spec).toMatchOpenAPISchema();
  });

  test('All endpoints have documentation', async () => {
    const routes = fastify.routes;
    const documentedPaths = Object.keys(spec.paths);

    routes.forEach((route) => {
      expect(documentedPaths).toContain(route.url);
    });
  });

  test('Code examples are valid', async () => {
    const generator = new CodeExamplesGenerator();
    const examples = generator.generateExamples('/issues', 'POST');

    // Validate syntax of generated examples
    expect(examples.curl).toMatch(/^curl /);
    expect(examples.typescript).toMatch(/import.*TammaAPI/);
    expect(examples.python).toMatch(/import requests/);
  });
});
```

### 2. Interactive Documentation Testing

```typescript
// packages/api/test/swagger-ui.test.ts
describe('Swagger UI', () => {
  test('Swagger UI loads correctly', async () => {
    const response = await fastify.inject({
      method: 'GET',
      url: '/docs',
    });

    expect(response.statusCode).toBe(200);
    expect(response.headers['content-type']).toMatch(/text\/html/);
  });

  test('OpenAPI JSON endpoint works', async () => {
    const response = await fastify.inject({
      method: 'GET',
      url: '/docs/json',
    });

    expect(response.statusCode).toBe(200);
    expect(response.headers['content-type']).toMatch(/application\/json/);

    const spec = JSON.parse(response.payload);
    expect(spec.openapi).toBe('3.1.0');
  });
});
```

## Success Metrics

### Documentation Quality

- [ ] 100% API endpoints documented
- [ ] All request/response schemas documented
- [ ] Interactive API explorer functional
- [ ] Code examples in 4+ languages
- [ ] Authentication flows documented
- [ ] Error handling documented

### Developer Experience

- [ ] API explorer loads in <2 seconds
- [ ] Code examples are copy-paste ready
- [ ] SDK documentation comprehensive
- [ ] Search functionality in docs
- [ ] Mobile-responsive documentation

### Maintenance

- [ ] Auto-generated from OpenAPI spec
- [ ] Versioned documentation
- [ ] Automated testing of examples
- [ ] Documentation coverage metrics
- [ ] Change detection and alerts

## Dependencies

### New Packages

```json
{
  "@fastify/swagger": "^8.12.0",
  "@fastify/swagger-ui": "^2.1.0",
  "swagger-jsdoc": "^6.2.8",
  "swagger-ui-express": "^5.0.0"
}
```

### Existing Packages

- `@tamma/api` - Core API server
- `@tamma/api-client` - TypeScript SDK
- `@tamma/shared` - Shared types and utilities

## Risks and Mitigations

### Documentation Drift

- **Risk**: Documentation becomes outdated as API changes
- **Mitigation**: Auto-generate from OpenAPI spec, CI/CD validation

### Example Accuracy

- **Risk**: Code examples don't work with current API
- **Mitigation**: Automated testing of all examples against live API

### Performance Impact

- **Risk**: Documentation generation slows API startup
- **Mitigation**: Lazy loading, caching, separate documentation server

### Security

- **Risk**: Documentation exposes sensitive endpoints
- **Mitigation**: Environment-based filtering, authentication requirements

## Rollout Plan

### Phase 1: Core Documentation (Week 1)

1. OpenAPI spec generation
2. Basic Swagger UI setup
3. Core endpoints documentation

### Phase 2: Enhanced Documentation (Week 2)

1. Code examples generator
2. Error documentation
3. Authentication flows

### Phase 3: SDK and Advanced Features (Week 3)

1. TypeScript SDK documentation
2. WebSocket/SSE documentation
3. Interactive examples

### Phase 4: Testing and Optimization (Week 4)

1. Documentation testing
2. Performance optimization
3. Production deployment

## Completion Criteria

- [ ] OpenAPI 3.1 spec generated and validated
- [ ] Swagger UI deployed at `/docs`
- [ ] All 40+ API endpoints documented
- [ ] Code examples in TypeScript, Python, JavaScript, curl
- [ ] Authentication and error handling documented
- [ ] TypeScript SDK with comprehensive documentation
- [ ] Interactive API explorer functional
- [ ] Documentation passes automated tests
- [ ] Performance benchmarks met (<2s load time)
- [ ] Security review completed
- [ ] Production deployment successful

---

**Story Context**: This story implements comprehensive API reference documentation for the Tamma platform, providing developers with complete, interactive documentation including OpenAPI specs, code examples, SDK documentation, and real-time API exploration capabilities.
