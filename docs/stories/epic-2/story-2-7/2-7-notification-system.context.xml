<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <story-id>2-7</story-id>
  <title>Notification System</title>
  <epic>2</epic>
  <theme>Autonomous Loop</theme>
  <created-at>2025-11-08T10:30:00.000Z</created-at>
  <updated-at>2025-11-08T10:30:00.000Z</updated-at>
  
  <summary>
    Implements a comprehensive multi-channel notification system for autonomous 
    development workflows. Provides intelligent notification routing, personalization, 
    and delivery tracking across email, Slack, Teams, and webhook channels.
  </summary>

  <dependencies>
    <dependency story-id="2-6">PR Creation and Management</dependency>
    <dependency story-id="2-5">Quality Gate Integration</dependency>
    <dependency story-id="2-3">Workflow Orchestration</dependency>
  </dependencies>

  <acceptance-criteria>
    <criteria id="AC1" priority="MUST">
      Send notifications across multiple channels (email, Slack, Teams, webhooks)
    </criteria>
    <criteria id="AC2" priority="MUST">
      Support intelligent notification routing based on user preferences
    </criteria>
    <criteria id="AC3" priority="MUST">
      Provide notification delivery tracking and retry mechanisms
    </criteria>
    <criteria id="AC4" priority="MUST">
      Support notification templates and personalization
    </criteria>
    <criteria id="AC5" priority="SHOULD">
      Implement notification batching and rate limiting
    </criteria>
    <criteria id="AC6" priority="SHOULD">
      Support notification digests and scheduled delivery
    </criteria>
    <criteria id="AC7" priority="COULD">
      Provide interactive notifications with action buttons
    </criteria>
    <criteria id="AC8" priority="COULD">
      Support notification analytics and user engagement tracking
    </criteria>
  </acceptance-criteria>

  <technical-context>
    <data-models>
      <model name="Notification">
        <description>Represents a notification in the system</description>
        <fields>
          <field name="id" type="string" required="true">Unique notification identifier</field>
          <field name="type" type="NotificationType" required="true">Notification type</field>
          <field name="priority" type="NotificationPriority" required="true">Notification priority</field>
          <field name="title" type="string" required="true">Notification title</field>
          <field name="content" type="string" required="true">Notification content/body</field>
          <field name="recipients" type="NotificationRecipient[]" required="true">List of recipients</field>
          <field name="channels" type="NotificationChannel[]" required="true">Delivery channels</field>
          <field name="template" type="string" required="false">Template used</field>
          <field name="variables" type="Record&lt;string, unknown&gt;" required="false">Template variables</field>
          <field name="metadata" type="Record&lt;string, unknown&gt;" required="false">Additional metadata</field>
          <field name="status" type="NotificationStatus" required="true">Current status</field>
          <field name="deliveryAttempts" type="number" required="true">Number of delivery attempts</field>
          <field name="scheduledAt" type="string" required="false">Scheduled delivery time</field>
          <field name="deliveredAt" type="string" required="false">Actual delivery time</field>
          <field name="expiresAt" type="string" required="false">Expiration time</field>
          <field name="createdAt" type="string" required="true">Creation timestamp</field>
          <field name="updatedAt" type="string" required="true">Last update timestamp</field>
        </fields>
      </model>

      <model name="NotificationType">
        <description>Enumeration of notification types</description>
        <values>
          <value>WORKFLOW_STARTED</value>
          <value>WORKFLOW_COMPLETED</value>
          <value>WORKFLOW_FAILED</value>
          <value>PR_CREATED</value>
          <value>PR_UPDATED</value>
          <value>PR_MERGED</value>
          <value>PR_REVIEW_REQUESTED</value>
          <value>BUILD_STARTED</value>
          <value>BUILD_COMPLETED</value>
          <value>BUILD_FAILED</value>
          <value>TEST_STARTED</value>
          <value>TEST_COMPLETED</value>
          <value>TEST_FAILED</value>
          <value>SECURITY_SCAN_COMPLETED</value>
          <value>DEPLOYMENT_STARTED</value>
          <value>DEPLOYMENT_COMPLETED</value>
          <value>DEPLOYMENT_FAILED</value>
          <value>ERROR_OCCURRED</value>
          <value>SYSTEM_MAINTENANCE</value>
        </values>
      </model>

      <model name="NotificationPriority">
        <description>Enumeration of notification priorities</description>
        <values>
          <value>LOW</value>
          <value>MEDIUM</value>
          <value>HIGH</value>
          <value>CRITICAL</value>
          <value>URGENT</value>
        </values>
      </model>

      <model name="NotificationStatus">
        <description>Enumeration of notification statuses</description>
        <values>
          <value>PENDING</value>
          <value>PROCESSING</value>
          <value>DELIVERED</value>
          <value>FAILED</value>
          <value>EXPIRED</value>
          <value>CANCELLED</value>
        </values>
      </model>

      <model name="NotificationRecipient">
        <description>Represents a notification recipient</description>
        <fields>
          <field name="userId" type="string" required="true">User identifier</field>
          <field name="email" type="string" required="false">Email address</field>
          <field name="slackUserId" type="string" required="false">Slack user ID</field>
          <field name="teamsUserId" type="string" required="false">Teams user ID</field>
          <field name="webhookUrl" type="string" required="false">Webhook URL</field>
          <field name="preferences" type="UserNotificationPreferences" required="false">User preferences</field>
        </fields>
      </model>

      <model name="NotificationChannel">
        <description>Enumeration of notification channels</description>
        <values>
          <value>EMAIL</value>
          <value>SLACK</value>
          <value>TEAMS</value>
          <value>WEBHOOK</value>
          <value>SMS</value>
          <value>PUSH</value>
          <value>IN_APP</value>
        </values>
      </model>

      <model name="UserNotificationPreferences">
        <description>User notification preferences</description>
        <fields>
          <field name="userId" type="string" required="true">User identifier</field>
          <field name="enabledChannels" type="NotificationChannel[]" required="true">Enabled channels</field>
          <field name="typePreferences" type="Record&lt;NotificationType, NotificationChannel[]&gt;" required="false">Preferences by type</field>
          <field name="quietHours" type="QuietHours" required="false">Quiet hours configuration</field>
          <field name="digestSettings" type="DigestSettings" required="false">Digest preferences</field>
          <field name="frequencyLimits" type="FrequencyLimits" required="false">Frequency limits</field>
        </fields>
      </model>

      <model name="QuietHours">
        <description>Quiet hours configuration</description>
        <fields>
          <field name="enabled" type="boolean" required="true">Whether quiet hours are enabled</field>
          <field name="startTime" type="string" required="false">Start time (HH:mm)</field>
          <field name="endTime" type="string" required="false">End time (HH:mm)</field>
          <field name="timezone" type="string" required="false">User timezone</field>
          <field name="weekdaysOnly" type="boolean" required="true">Apply only on weekdays</field>
          <field name="allowUrgent" type="boolean" required="true">Allow urgent notifications</field>
        </fields>
      </model>

      <model name="DigestSettings">
        <description>Digest notification settings</description>
        <fields>
          <field name="enabled" type="boolean" required="true">Whether digests are enabled</field>
          <field name="frequency" type="DigestFrequency" required="false">Digest frequency</field>
          <field name="time" type="string" required="false">Digest delivery time</field>
          <field name="includeTypes" type="NotificationType[]" required="false">Types to include in digest</field>
        </fields>
      </model>

      <model name="DigestFrequency">
        <description>Enumeration of digest frequencies</description>
        <values>
          <value>HOURLY</value>
          <value>DAILY</value>
          <value>WEEKLY</value>
          <value>MONTHLY</value>
        </values>
      </model>

      <model name="FrequencyLimits">
        <description>Notification frequency limits</description>
        <fields>
          <field name="maxPerHour" type="number" required="false">Maximum notifications per hour</field>
          <field name="maxPerDay" type="number" required="false">Maximum notifications per day</field>
          <field name="cooldownMinutes" type="number" required="false">Cooldown between similar notifications</field>
        </fields>
      </model>

      <model name="NotificationTemplate">
        <description>Notification template definition</description>
        <fields>
          <field name="id" type="string" required="true">Template identifier</field>
          <field name="type" type="NotificationType" required="true">Notification type</field>
          <field name="channel" type="NotificationChannel" required="true">Target channel</field>
          <field name="subjectTemplate" type="string" required="false">Subject template (email)</field>
          <field name="titleTemplate" type="string" required="false">Title template</field>
          <field name="contentTemplate" type="string" required="true">Content template</field>
          <field name="variables" type="TemplateVariable[]" required="false">Template variables</field>
          <field name="defaultLocale" type="string" required="true">Default locale</field>
          <field name="localizedVersions" type="Record&lt;string, LocalizedTemplate&gt;" required="false">Localized versions</field>
        </fields>
      </model>

      <model name="TemplateVariable">
        <description>Template variable definition</description>
        <fields>
          <field name="name" type="string" required="true">Variable name</field>
          <field name="type" type="VariableType" required="true">Variable type</field>
          <field name="required" type="boolean" required="true">Whether variable is required</field>
          <field name="defaultValue" type="string" required="false">Default value</field>
          <field name="description" type="string" required="false">Variable description</field>
        </fields>
      </model>

      <model name="VariableType">
        <description>Enumeration of variable types</description>
        <values>
          <value>STRING</value>
          <value>NUMBER</value>
          <value>BOOLEAN</value>
          <value>DATE</value>
          <value>URL</value>
          <value>EMAIL</value>
        </values>
      </model>

      <model name="LocalizedTemplate">
        <description>Localized template version</description>
        <fields>
          <field name="subjectTemplate" type="string" required="false">Localized subject</field>
          <field name="titleTemplate" type="string" required="false">Localized title</field>
          <field name="contentTemplate" type="string" required="true">Localized content</field>
        </fields>
      </model>

      <model name="DeliveryReport">
        <description>Notification delivery report</description>
        <fields>
          <field name="notificationId" type="string" required="true">Notification ID</field>
          <field name="channel" type="NotificationChannel" required="true">Delivery channel</field>
          <field name="recipient" type="string" required="true">Recipient identifier</field>
          <field name="status" type="DeliveryStatus" required="true">Delivery status</field>
          <field name="attemptedAt" type="string" required="true">Attempt timestamp</field>
          <field name="deliveredAt" type="string" required="false">Delivery timestamp</field>
          <field name="errorMessage" type="string" required="false">Error message if failed</field>
          <field name="responseCode" type="string" required="false">Response code from provider</field>
        </fields>
      </model>

      <model name="DeliveryStatus">
        <description>Enumeration of delivery statuses</description>
        <values>
          <value>PENDING</value>
          <value>SENT</value>
          <value>DELIVERED</value>
          <value>FAILED</value>
          <value>BOUNCED</value>
          <value>COMPLAINED</value>
          <value>UNSUBSCRIBED</value>
        </values>
      </model>
    </data-models>

    <interfaces>
      <interface name="INotificationService">
        <description>Main notification service interface</description>
        <methods>
          <method name="sendNotification" async="true">
            <param name="request" type="SendNotificationRequest">Notification request</param>
            <returns type="Notification">Created notification</returns>
          </method>
          <method name="sendBulkNotifications" async="true">
            <param name="requests" type="SendNotificationRequest[]">Bulk notification requests</param>
            <returns type="Notification[]">Created notifications</returns>
          </method>
          <method name="getNotification" async="true">
            <param name="notificationId" type="string">Notification ID</param>
            <returns type="Notification">Notification details</returns>
          </method>
          <method name="listNotifications" async="true">
            <param name="filters" type="NotificationFilters">Filter criteria</param>
            <returns type="Notification[]">List of notifications</returns>
          </method>
          <method name="updateNotification" async="true">
            <param name="notificationId" type="string">Notification ID</param>
            <param name="updates" type="NotificationUpdateRequest">Update request</param>
            <returns type="Notification">Updated notification</returns>
          </method>
          <method name="cancelNotification" async="true">
            <param name="notificationId" type="string">Notification ID</param>
            <returns type="boolean">Cancellation success</returns>
          </method>
          <method name="retryFailedNotification" async="true">
            <param name="notificationId" type="string">Notification ID</param>
            <returns type="boolean">Retry success</returns>
          </method>
        </methods>
      </interface>

      <interface name="INotificationChannel">
        <description>Interface for notification channel implementations</description>
        <methods>
          <method name="send" async="true">
            <param name="notification" type="Notification">Notification to send</param>
            <param name="recipient" type="NotificationRecipient">Target recipient</param>
            <returns type="DeliveryReport">Delivery report</returns>
          </method>
          <method name="validateRecipient" async="true">
            <param name="recipient" type="NotificationRecipient">Recipient to validate</param>
            <returns type="ValidationResult">Validation result</returns>
          </method>
          <method name="getCapabilities">
            <returns type="ChannelCapabilities">Channel capabilities</returns>
          </method>
        </methods>
      </interface>

      <interface name="INotificationTemplateEngine">
        <description>Interface for notification template processing</description>
        <methods>
          <method name="renderTemplate" async="true">
            <param name="templateId" type="string">Template ID</param>
            <param name="variables" type="Record&lt;string, unknown&gt;">Template variables</param>
            <param name="locale" type="string">Target locale</param>
            <returns type="RenderedTemplate">Rendered template</returns>
          </method>
          <method name="validateTemplate" async="true">
            <param name="template" type="NotificationTemplate">Template to validate</param>
            <returns type="ValidationResult">Validation result</returns>
          </method>
          <method name="registerTemplate" async="true">
            <param name="template" type="NotificationTemplate">Template to register</param>
            <returns type="boolean">Registration success</returns>
          </method>
        </methods>
      </interface>

      <interface name="INotificationRouter">
        <description>Interface for intelligent notification routing</description>
        <methods>
          <method name="routeNotification" async="true">
            <param name="notification" type="Notification">Notification to route</param>
            <returns type="RoutingDecision">Routing decision</returns>
          </method>
          <method name="shouldBatch" async="true">
            <param name="notifications" type="Notification[]">Notifications to evaluate</param>
            <returns type="boolean">Whether to batch</returns>
          </method>
          <method name="shouldDelay" async="true">
            <param name="notification" type="Notification">Notification to evaluate</param>
            <returns type="DelayDecision">Delay decision</returns>
          </method>
        </methods>
      </interface>

      <interface name="IUserPreferencesService">
        <description>Interface for user preference management</description>
        <methods>
          <method name="getPreferences" async="true">
            <param name="userId" type="string">User ID</param>
            <returns type="UserNotificationPreferences">User preferences</returns>
          </method>
          <method name="updatePreferences" async="true">
            <param name="userId" type="string">User ID</param>
            <param name="preferences" type="UserNotificationPreferences">Updated preferences</param>
            <returns type="boolean">Update success</returns>
          </method>
          <method name="isWithinQuietHours" async="true">
            <param name="userId" type="string">User ID</param>
            <returns type="boolean">Whether within quiet hours</returns>
          </method>
        </methods>
      </interface>
    </interfaces>

    <key-classes>
      <class name="NotificationService">
        <description>Main notification service implementation</description>
        <implements>INotificationService</implements>
        <dependencies>
          <dependency>INotificationChannel[]</dependency>
          <dependency>INotificationTemplateEngine</dependency>
          <dependency>INotificationRouter</dependency>
          <dependency>IUserPreferencesService</dependency>
          <dependency>IEventStore</dependency>
          <dependency>ILogger</dependency>
        </dependencies>
        <methods>
          <method name="sendNotification" visibility="public" async="true">
            <description>Sends a single notification</description>
            <implementation>
              1. Validate notification request
              2. Create notification record
              3. Apply routing logic
              4. Render templates for each channel
              5. Send to appropriate channels
              6. Update delivery status
              7. Emit notification events
              8. Return notification details
            </implementation>
          </method>
          <method name="sendBulkNotifications" visibility="public" async="true">
            <description>Sends multiple notifications efficiently</description>
            <implementation>
              1. Validate all notification requests
              2. Group notifications by type and channel
              3. Apply batching logic
              4. Render templates in batch
              5. Send to channels in parallel
              6. Update delivery statuses
              7. Emit bulk notification events
              8. Return notification details
            </implementation>
          </method>
          <method name="retryFailedNotification" visibility="public" async="true">
            <description>Retries a failed notification</description>
            <implementation>
              1. Check retry eligibility
              2. Update retry count
              3. Apply exponential backoff
              4. Re-execute delivery logic
              5. Update delivery status
              6. Emit retry event
              7. Return retry result
            </implementation>
          </method>
        </methods>
      </class>

      <class name="EmailNotificationChannel">
        <description>Email notification channel implementation</description>
        <implements>INotificationChannel</implements>
        <dependencies>
          <dependency>IEmailProvider</dependency>
          <dependency>ILogger</dependency>
        </dependencies>
        <methods>
          <method name="send" visibility="public" async="true">
            <description>Sends email notification</description>
            <implementation>
              1. Validate email address
              2. Compose email message
              3. Apply email formatting
              4. Send via email provider
              5. Track delivery status
              6. Return delivery report
            </implementation>
          </method>
        </methods>
      </class>

      <class name="SlackNotificationChannel">
        <description>Slack notification channel implementation</description>
        <implements>INotificationChannel</implements>
        <dependencies>
          <dependency>ISlackClient</dependency>
          <dependency>ILogger</dependency>
        </dependencies>
        <methods>
          <method name="send" visibility="public" async="true">
            <description>Sends Slack notification</description>
            <implementation>
              1. Validate Slack user ID
              2. Format Slack message
              3. Add interactive elements if needed
              4. Send via Slack API
              5. Track delivery status
              6. Return delivery report
            </implementation>
          </method>
        </methods>
      </class>

      <class name="TeamsNotificationChannel">
        <description>Microsoft Teams notification channel implementation</description>
        <implements>INotificationChannel</implements>
        <dependencies>
          <dependency>ITeamsClient</dependency>
          <dependency>ILogger</dependency>
        </dependencies>
        <methods>
          <method name="send" visibility="public" async="true">
            <description>Sends Teams notification</description>
            <implementation>
              1. Validate Teams user ID
              2. Format Teams message
              3. Add adaptive cards if needed
              4. Send via Teams API
              5. Track delivery status
              6. Return delivery report
            </implementation>
          </method>
        </methods>
      </class>

      <class name="WebhookNotificationChannel">
        <description>Webhook notification channel implementation</description>
        <implements>INotificationChannel</implements>
        <dependencies>
          <dependency>IHttpClient</dependency>
          <dependency>ILogger</dependency>
        </dependencies>
        <methods>
          <method name="send" visibility="public" async="true">
            <description>Sends webhook notification</description>
            <implementation>
              1. Validate webhook URL
              2. Format webhook payload
              3. Apply security headers
              4. Send HTTP request
              5. Handle response and retries
              6. Track delivery status
              7. Return delivery report
            </implementation>
          </method>
        </methods>
      </class>

      <class name="NotificationTemplateEngine">
        <description>Template processing engine</description>
        <implements>INotificationTemplateEngine</implements>
        <dependencies>
          <dependency>ITemplateRenderer</dependency>
          <dependency>ILogger</dependency>
        </dependencies>
        <methods>
          <method name="renderTemplate" visibility="public" async="true">
            <description>Renders notification template</description>
            <implementation>
              1. Load template by ID
              2. Select localized version
              3. Validate required variables
              4. Apply template rendering
              5. Sanitize output
              6. Return rendered template
            </implementation>
          </method>
        </methods>
      </class>

      <class name="NotificationRouter">
        <description>Intelligent notification routing</description>
        <implements>INotificationRouter</implements>
        <dependencies>
          <dependency>IUserPreferencesService</dependency>
          <dependency>ILogger</dependency>
        </dependencies>
        <methods>
          <method name="routeNotification" visibility="public" async="true">
            <description>Determines optimal routing for notification</description>
            <implementation>
              1. Check user preferences
              2. Evaluate quiet hours
              3. Apply frequency limits
              4. Consider notification priority
              5. Select appropriate channels
              6. Apply batching logic
              7. Return routing decision
            </implementation>
          </method>
        </methods>
      </class>

      <class name="NotificationScheduler">
        <description>Handles scheduled and digest notifications</description>
        <dependencies>
          <dependency>IScheduler</dependency>
          <dependency>INotificationService</dependency>
          <dependency>ILogger</dependency>
        </dependencies>
        <methods>
          <method name="scheduleNotification" visibility="public" async="true">
            <description>Schedules notification for future delivery</description>
            <implementation>
              1. Validate schedule time
              2. Create scheduled task
              3. Store notification with scheduled status
              4. Set up scheduler job
              5. Return scheduling confirmation
            </implementation>
          </method>
          <method name="processDigests" visibility="public" async="true">
            <description>Processes digest notifications</description>
            <implementation>
              1. Find users with digest preferences
              2. Collect pending notifications
              3. Group by digest frequency
              4. Render digest templates
              5. Send digest notifications
              6. Mark notifications as processed
            </implementation>
          </method>
        </methods>
      </class>
    </key-classes>

    <integration-points>
      <integration name="Email Service Integration">
        <description>Integration with email service providers</description>
        <providers>
          <provider>SendGrid</provider>
          <provider>Amazon SES</provider>
          <provider>Mailgun</provider>
          <provider>SMTP</provider>
        </providers>
        <operations>
          <operation>Email sending</operation>
          <operation>Delivery tracking</operation>
          <operation>Bounce handling</operation>
          <operation>Unsubscribe management</operation>
        </operations>
      </integration>

      <integration name="Slack Integration">
        <description>Integration with Slack API</description>
        <operations>
          <operation>Direct message sending</operation>
          <operation>Channel posting</operation>
          <operation>Interactive buttons</operation>
          <operation>User presence checking</operation>
        </operations>
      </integration>

      <integration name="Microsoft Teams Integration">
        <description>Integration with Microsoft Teams API</description>
        <operations>
          <operation>Direct message sending</operation>
          <operation>Adaptive cards</operation>
          <operation>Channel posting</operation>
          <operation>Meeting notifications</operation>
        </operations>
      </integration>

      <integration name="Webhook Integration">
        <description>Integration with external webhook endpoints</description>
        <operations>
          <operation>HTTP POST requests</operation>
          <operation>Signature verification</operation>
          <operation>Retry handling</operation>
          <operation>Response processing</operation>
        </operations>
      </integration>
    </integration-points>

    <api-endpoints>
      <endpoint method="POST" path="/api/v1/notifications">
        <description>Send a notification</description>
        <request-body type="SendNotificationRequest">Notification details</request-body>
        <response type="Notification">Created notification</response>
        <status-codes>
          <code>201</code>
          <code>400</code>
          <code>422</code>
        </status-codes>
      </endpoint>

      <endpoint method="POST" path="/api/v1/notifications/bulk">
        <description>Send multiple notifications</description>
        <request-body type="SendNotificationRequest[]">Bulk notification requests</request-body>
        <response type="Notification[]">Created notifications</response>
        <status-codes>
          <code>201</code>
          <code>400</code>
          <code>422</code>
        </status-codes>
      </endpoint>

      <endpoint method="GET" path="/api/v1/notifications/{notificationId}">
        <description>Get notification details</description>
        <response type="Notification">Notification details</response>
        <status-codes>
          <code>200</code>
          <code>404</code>
        </status-codes>
      </endpoint>

      <endpoint method="PATCH" path="/api/v1/notifications/{notificationId}">
        <description>Update notification</description>
        <request-body type="NotificationUpdateRequest">Update details</request-body>
        <response type="Notification">Updated notification</response>
        <status-codes>
          <code>200</code>
          <code>404</code>
          <code>422</code>
        </status-codes>
      </endpoint>

      <endpoint method="POST" path="/api/v1/notifications/{notificationId}/retry">
        <description>Retry failed notification</description>
        <response type="boolean">Retry success</response>
        <status-codes>
          <code>200</code>
          <code>404</code>
          <code>409</code>
        </status-codes>
      </endpoint>

      <endpoint method="DELETE" path="/api/v1/notifications/{notificationId}">
        <description>Cancel notification</description>
        <response type="boolean">Cancellation success</response>
        <status-codes>
          <code>200</code>
          <code>404</code>
          <code>409</code>
        </status-codes>
      </endpoint>

      <endpoint method="GET" path="/api/v1/notifications">
        <description>List notifications with filters</description>
        <query-params>
          <param name="userId" type="string">Filter by user</param>
          <param name="type" type="NotificationType">Filter by type</param>
          <param name="status" type="NotificationStatus">Filter by status</param>
          <param name="channel" type="NotificationChannel">Filter by channel</param>
          <param name="fromDate" type="string">Filter by date range (start)</param>
          <param name="toDate" type="string">Filter by date range (end)</param>
        </query-params>
        <response type="Notification[]">List of notifications</response>
        <status-codes>
          <code>200</code>
        </status-codes>
      </endpoint>

      <endpoint method="GET" path="/api/v1/users/{userId}/preferences">
        <description>Get user notification preferences</description>
        <response type="UserNotificationPreferences">User preferences</response>
        <status-codes>
          <code>200</code>
          <code>404</code>
        </status-codes>
      </endpoint>

      <endpoint method="PUT" path="/api/v1/users/{userId}/preferences">
        <description>Update user notification preferences</description>
        <request-body type="UserNotificationPreferences">Updated preferences</request-body>
        <response type="UserNotificationPreferences">Updated preferences</response>
        <status-codes>
          <code>200</code>
          <code>404</code>
          <code>422</code>
        </status-codes>
      </endpoint>

      <endpoint method="GET" path="/api/v1/templates">
        <description>List notification templates</description>
        <query-params>
          <param name="type" type="NotificationType">Filter by type</param>
          <param name="channel" type="NotificationChannel">Filter by channel</param>
        </query-params>
        <response type="NotificationTemplate[]">List of templates</response>
        <status-codes>
          <code>200</code>
        </status-codes>
      </endpoint>

      <endpoint method="POST" path="/api/v1/templates">
        <description>Create notification template</description>
        <request-body type="NotificationTemplate">Template details</request-body>
        <response type="NotificationTemplate">Created template</response>
        <status-codes>
          <code>201</code>
          <code>400</code>
          <code>422</code>
        </status-codes>
      </endpoint>
    </api-endpoints>

    <testing-strategy>
      <unit-tests>
        <test-suite name="NotificationService Tests">
          <test-case name="should send notification successfully">
            <description>Tests notification sending with valid request</description>
            <setup>Mock channels, template engine, router</setup>
            <input>Valid SendNotificationRequest</input>
            <expected>Created Notification object</expected>
          </test-case>
          <test-case name="should handle routing logic correctly">
            <description>Tests intelligent notification routing</description>
            <setup>Mock user preferences, router</setup>
            <input>Notification with routing requirements</input>
            <expected>Correct routing decision applied</expected>
          </test-case>
          <test-case name="should retry failed notifications">
            <description>Tests retry mechanism for failed notifications</description>
            <setup>Mock failed notification, retry logic</setup>
            <input>Failed notification ID</input>
            <expected>Notification retried successfully</expected>
          </test-case>
        </test-suite>

        <test-suite name="NotificationChannel Tests">
          <test-case name="should send email notification">
            <description>Tests email channel delivery</description>
            <setup>Mock email provider, valid recipient</setup>
            <input>Email notification</input>
            <expected>Successful delivery report</expected>
          </test-case>
          <test-case name="should send Slack notification">
            <description>Tests Slack channel delivery</description>
            <setup>Mock Slack client, valid user ID</setup>
            <input>Slack notification</input>
            <expected>Successful delivery report</expected>
          </test-case>
          <test-case name="should send webhook notification">
            <description>Tests webhook channel delivery</description>
            <setup>Mock HTTP client, valid webhook URL</setup>
            <input>Webhook notification</input>
            <expected>Successful delivery report</expected>
          </test-case>
        </test-suite>

        <test-suite name="TemplateEngine Tests">
          <test-case name="should render template correctly">
            <description>Tests template rendering with variables</description>
            <setup>Mock template, variables</setup>
            <input>Template ID and variables</input>
            <expected>Correctly rendered template</expected>
          </test-case>
          <test-case name="should handle localized templates">
            <description>Tests template localization</description>
            <setup>Mock localized template</setup>
            <input>Template ID and locale</input>
            <expected>Localized rendered template</expected>
          </test-case>
        </test-suite>
      </unit-tests>

      <integration-tests>
        <test-suite name="Email Service Integration">
          <test-case name="should send email via SendGrid">
            <description>Tests actual email sending via SendGrid</description>
            <setup>SendGrid test credentials, valid email</setup>
            <input>Email notification</input>
            <expected>Email delivered successfully</expected>
          </test-case>
        </test-suite>

        <test-suite name="Slack Integration">
          <test-case name="should send Slack message">
            <description>Tests actual Slack message sending</description>
            <setup>Slack bot token, test channel</setup>
            <input>Slack notification</input>
            <expected>Message posted to Slack</expected>
          </test-case>
        </test-suite>

        <test-suite name="Webhook Integration">
          <test-case name="should call webhook endpoint">
            <description>Tests actual webhook delivery</description>
            <setup>Test webhook server, valid URL</setup>
            <input>Webhook notification</input>
            <expected>Webhook called with correct payload</expected>
          </test-case>
        </test-suite>
      </integration-tests>

      <end-to-end-tests>
        <test-suite name="Notification Lifecycle Tests">
          <test-case name="should handle complete notification flow">
            <description>Tests notification from creation to delivery</description>
            <setup>Complete notification environment</setup>
            <input>Workflow event requiring notification</input>
            <expected>Notification delivered to all channels</expected>
          </test-case>
        </test-suite>
      </end-to-end-tests>
    </testing-strategy>

    <security-considerations>
      <consideration name="Data Privacy">
        <description>Protect user data in notifications</description>
        <implementation>
          - Sanitize notification content
          - Redact sensitive information
          - Comply with GDPR/CCPA
          - Implement data retention policies
        </implementation>
      </consideration>

      <consideration name="Access Control">
        <description>Control access to notification features</description>
        <implementation>
          - Authenticate all API requests
          - Authorize notification sending
          - Validate recipient permissions
          - Implement rate limiting
        </implementation>
      </consideration>

      <consideration name="Content Security">
        <description>Prevent malicious content in notifications</description>
        <implementation>
          - Sanitize HTML content
          - Validate URLs and links
          - Prevent XSS attacks
          - Implement content security policies
        </implementation>
      </consideration>

      <consideration name="Webhook Security">
        <description>Secure webhook communications</description>
        <implementation>
          - Use HTTPS for all webhooks
          - Implement signature verification
          - Validate webhook URLs
          - Handle webhook failures securely
        </implementation>
      </consideration>
    </security-considerations>

    <monitoring-requirements>
      <metric name="notification_delivery_time">
        <description>Time taken to deliver notifications</description>
        <type>histogram</type>
        <unit>milliseconds</unit>
        <thresholds>
          <threshold level="warning">5000ms</threshold>
          <threshold level="critical">10000ms</threshold>
        </thresholds>
      </metric>

      <metric name="notification_success_rate">
        <description>Success rate of notification delivery</description>
        <type>counter</type>
        <unit>percentage</unit>
        <thresholds>
          <threshold level="warning">95%</threshold>
          <threshold level="critical">90%</threshold>
        </thresholds>
      </metric>

      <metric name="channel_delivery_success_rate">
        <description>Success rate by channel</description>
        <type>gauge</type>
        <labels>
          <label>channel</label>
        </labels>
        <unit>percentage</unit>
        <thresholds>
          <threshold level="warning">95%</threshold>
          <threshold level="critical">90%</threshold>
        </thresholds>
      </metric>

      <metric name="notification_volume">
        <description>Volume of notifications sent</description>
        <type>counter</type>
        <labels>
          <label>type</label>
          <label>channel</label>
          <label>status</label>
        </labels>
      </metric>

      <metric name="template_rendering_time">
        <description>Time taken to render templates</description>
        <type>histogram</type>
        <unit>milliseconds</unit>
        <thresholds>
          <threshold level="warning">1000ms</threshold>
          <threshold level="critical">2000ms</threshold>
        </thresholds>
      </metric>
    </monitoring-requirements>

    <success-metrics>
      <metric name="delivery_success_rate">
        <target>98%</target>
        <description>Percentage of notifications delivered successfully</description>
      </metric>

      <metric name="delivery_latency">
        <target>&lt;5 seconds</target>
        <description>Average time from notification creation to delivery</description>
      </metric>

      <metric name="channel_coverage">
        <target>100%</target>
        <description>Support for all required notification channels</description>
      </metric>

      <metric name="user_satisfaction">
        <target>90%</target>
        <description>User satisfaction with notification relevance and timing</description>
      </metric>

      <metric name="template_effectiveness">
        <target>95%</target>
        <description>Percentage of templates rendered without errors</description>
      </metric>
    </success-metrics>

    <risk-mitigation>
      <risk name="Channel Failures">
        <probability>Medium</probability>
        <impact>High</impact>
        <mitigation>
          - Implement multiple channel support
          - Use retry mechanisms with exponential backoff
          - Monitor channel health
          - Provide fallback channels
        </mitigation>
      </risk>

      <risk name="Spam Complaints">
        <probability>Low</probability>
        <impact>High</impact>
        <mitigation>
          - Implement frequency limits
          - Respect user preferences
          - Provide unsubscribe options
          - Monitor complaint rates
        </mitigation>
      </risk>

      <risk name="Template Errors">
        <probability>Medium</probability>
        <impact>Medium</impact>
        <mitigation>
          - Validate templates before use
          - Provide template testing tools
          - Implement fallback templates
          - Monitor rendering errors
        </mitigation>
      </risk>

      <risk name="Rate Limiting">
        <probability>High</probability>
        <impact>Medium</impact>
        <mitigation>
          - Implement intelligent batching
          - Use queue-based processing
          - Monitor API limits
          - Implement backpressure handling
        </mitigation>
      </risk>
    </risk-mitigation>
  </technical-context>
</story-context>