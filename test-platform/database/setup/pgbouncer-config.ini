;; PgBouncer Configuration Template
;; Story: 1.1 Database Schema Migration System
;; Task: 1 - Database Setup and Configuration
;; Subtask: 1.3 - Configure connection pooling with PgBouncer

;;;
;;; DATABASES
;;;

[databases]
;; Database connection configuration
;; Format: dbname = host=<host> port=<port> dbname=<actual_dbname>
test_platform = host=localhost port=5432 dbname=test_platform

;; Additional database connections can be added here
;; staging = host=localhost port=5432 dbname=test_platform_staging
;; production = host=localhost port=5432 dbname=test_platform_prod

;;;
;;; USERS
;;;

;; User-specific settings can be configured here
;; [users]
;; test_platform_user = pool_mode=transaction max_user_connections=10

;;;
;;; CONNECTION POOL
;;;

[pgbouncer]

;; Network configuration
listen_port = 6432
listen_addr = 127.0.0.1
;; Uncomment to listen on all interfaces (use with caution)
;; listen_addr = *

;; Unix socket configuration (optional)
;; unix_socket_dir = /tmp
;; unix_socket_mode = 0755

;; Authentication configuration
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt
;; Alternative: use HBA file for more complex auth rules
;; auth_type = hba
;; auth_hba_file = /etc/pgbouncer/pgbouncer_hba.conf

;; Administrative users
admin_users = postgres, admin
stats_users = stats, postgres, monitor

;; Pool configuration
pool_mode = transaction
;; transaction: Release connection back to pool after transaction completes (recommended)
;; session: Connection returned to pool when client disconnects
;; statement: Connection returned after each statement (limited use cases)

;; Connection limits
max_client_conn = 200          ; Maximum number of client connections allowed
default_pool_size = 20         ; Default connections per user/database pair
min_pool_size = 5              ; Minimum number of server connections per pool
reserve_pool_size = 5          ; Additional connections for urgent requests
reserve_pool_timeout = 5       ; Seconds to wait for reserve pool
max_db_connections = 50        ; Maximum connections per database
max_user_connections = 50      ; Maximum connections per user

;; Connection behavior
server_reset_query = DISCARD ALL    ; Query to clean connection state
;; Alternative for older PostgreSQL versions:
;; server_reset_query = RESET ALL; SET SESSION AUTHORIZATION DEFAULT

;; Health checks and timeouts
server_check_delay = 30        ; Seconds between connection checks
server_check_query = select 1  ; Query used to check if connection is alive
server_lifetime = 3600          ; Maximum age of server connections (1 hour)
server_idle_timeout = 600       ; Disconnect servers idle for this many seconds
server_connect_timeout = 15    ; Seconds to wait for server connection
server_login_retry = 15         ; Seconds between connection retries
client_login_timeout = 60      ; Seconds to wait for client authentication
query_timeout = 0               ; Query timeout in seconds (0 = disabled)
query_wait_timeout = 120        ; Maximum time queries can wait for execution
client_idle_timeout = 0         ; Client idle timeout (0 = disabled)

;; Connection handling
server_round_robin = 0          ; Enable round-robin for server connections
ignore_startup_parameters = extra_float_digits, application_name

;;;
;;; LOG SETTINGS
;;;

;; Logging configuration
logfile = /var/log/pgbouncer/pgbouncer.log
pidfile = /var/run/pgbouncer/pgbouncer.pid
;; Log levels: 0=silent, 1=error, 2=warning, 3=info, 4=debug
log_connections = 1             ; Log successful connections
log_disconnections = 1          ; Log disconnections
log_pooler_errors = 1           ; Log errors from pool
stats_period = 60               ; Write aggregated stats to log every N seconds

;; Syslog configuration (optional)
;; syslog = 1
;; syslog_facility = daemon
;; syslog_ident = pgbouncer

;;;
;;; CONSOLE ACCESS CONTROL
;;;

;; Address allowed to connect to console
;; admin_users need this to connect to console
;; Use 'all' to allow any address (not recommended for production)
;; admin_users = postgres
;; stats_users = stats

;;;
;;; TLS SETTINGS (Optional)
;;;

;; Enable TLS
;; client_tls_sslmode = prefer
;; client_tls_ca_file = /etc/pgbouncer/root.crt
;; client_tls_cert_file = /etc/pgbouncer/server.crt
;; client_tls_key_file = /etc/pgbouncer/server.key
;; client_tls_protocols = secure
;; client_tls_ciphers = HIGH:MEDIUM:+3DES:!aNULL

;; TLS for server connections
;; server_tls_sslmode = prefer
;; server_tls_ca_file = /etc/pgbouncer/root.crt
;; server_tls_protocols = secure
;; server_tls_ciphers = HIGH:MEDIUM:+3DES:!aNULL

;;;
;;; DANGEROUS TIMEOUTS
;;;
;; These should be used with care as they can cause unexpected behavior

;; idle_transaction_timeout = 0  ; Dangerous in production
;; suspend_timeout = 10           ; Used with PAUSE/SUSPEND commands

;;;
;;; LOW-LEVEL NETWORK SETTINGS
;;;

;; TCP keepalive settings
tcp_keepalive = 1               ; Enable TCP keepalive
tcp_keepidle = 0                ; Use system default
tcp_keepintvl = 0               ; Use system default
tcp_keepcnt = 0                 ; Use system default
tcp_user_timeout = 0            ; Use system default

;; DNS settings
dns_max_ttl = 15                ; Seconds to cache DNS lookups
dns_nxdomain_ttl = 15           ; Seconds to cache failed DNS lookups
dns_zone_check_period = 0       ; Disable periodic DNS checks

;; Buffer settings
pkt_buf = 4096                  ; Internal buffer size for packets
max_packet_size = 2147483647    ; Maximum packet size (default is max int)
listen_backlog = 128            ; Backlog for listen queue
sbuf_loopcnt = 5                ; How many results to process per loop
so_reuseport = 0                ; Use SO_REUSEPORT socket option
tcp_defer_accept = 0            ; Use TCP_DEFER_ACCEPT
tcp_socket_buffer = 0           ; Use system default

;;;
;;; MONITORING
;;;

;; Application name for PostgreSQL monitoring
application_name_add_host = 0   ; Add client host:port to application_name

;; Disable certain features if needed
;; disable_pqexec = 0            ; Disable simple query protocol