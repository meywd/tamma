<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>5</storyId>
    <title>Configuration Management & Environment Setup</title>
    <status>drafted</status>
    <generatedAt>2025-11-08</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>/home/meywd/tamma/test-platform/docs/stories/1-5-configuration-management-environment-setup.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a developer</asA>
    <iWant>a robust configuration management system</iWant>
    <soThat>the application can run across different environments with proper settings</soThat>
    <tasks>Task 1: Environment Configuration System (AC: #1, #3)
- Subtask 1.1: Create configuration schema with environment-specific settings
- Subtask 1.2: Implement environment variable loading and validation
- Subtask 1.3: Add configuration validation on application startup
- Subtask 1.4: Create configuration documentation with examples
Task 2: Secrets Management (AC: #2)
- Subtask 2.1: Implement secure storage for API keys and credentials
- Subtask 2.2: Add encryption for sensitive configuration values
- Subtask 2.3: Create secrets rotation mechanisms
- Subtask 2.4: Add environment-specific secret loading
Task 3: Docker Configuration (AC: #5)
- Subtask 3.1: Create multi-stage Dockerfile for production builds
- Subtask 3.2: Configure Docker Compose for development environment
- Subtask 3.3: Add environment-specific Docker configurations
- Subtask 3.4: Implement health checks in Docker containers
Task 4: Development Environment (AC: #6)
- Subtask 4.1: Set up hot reloading for development
- Subtask 4.2: Configure development database and services
- Subtask 4.3: Create development scripts and tooling
- Subtask 4.4: Add development environment documentation
Task 5: Logging Configuration (AC: #7)
- Subtask 5.1: Implement structured JSON logging with Pino
- Subtask 5.2: Configure log levels per environment
- Subtask 5.3: Add correlation ID tracking for requests
- Subtask 5.4: Set up log aggregation and rotation
Task 6: Health Monitoring (AC: #8)
- Subtask 6.1: Create health check endpoints for all services
- Subtask 6.2: Implement dependency health checking
- Subtask 6.3: Add readiness and liveness probes
- Subtask 6.4: Configure health check monitoring and alerting</tasks>
  </story>

  <acceptanceCriteria>1. Environment-based configuration (development, staging, production)
2. Secure handling of sensitive data (API keys, database credentials)
3. Configuration validation on startup
4. Environment variable documentation with examples
5. Docker containerization with multi-stage builds
6. Development environment setup with hot reloading
7. Logging configuration with structured JSON output
8. Health check endpoints for monitoring</acceptanceCriteria>

  <documentation>
    <doc path="test-platform/docs/tech-spec-epic-1.md" title="Technical Specification Epic 1" section="Configuration Management & Environment Setup">
      <snippet>Configuration schema with DatabaseConfig, RedisConfig, JWTConfig, and AppConfig interfaces. Environment-based configuration with validation, secrets management, and Docker containerization support.</snippet>
    </doc>
    <doc path="test-platform/docs/tech-spec-epic-1.md" title="Technology Stack" section="Core Technologies">
      <snippet>PostgreSQL 17 with JSONB, Redis 7.x, Fastify 5.x, TypeScript 5.7+, Node.js 22 LTS, pnpm 9+, Vitest 3.x. Connection pooling with PgBouncer, structured JSON logging with correlation IDs.</snippet>
    </doc>
    <doc path="test-platform/docs/epics.md" title="Epic 1 Foundation" section="Story 1.5">
      <snippet>Configuration Management & Environment Setup - Environment variables, config validation, secrets management. Working development environment with secure user access and data persistence.</snippet>
    </doc>
    <doc path="test-platform/docs/PRD.md" title="Product Requirements" section="Technical Integration">
      <snippet>Integration with development environments and dynamic model discovery from configured AI providers. Multi-provider support with secure credential management.</snippet>
    </doc>
  </documentation>

  <artifacts>
    <docs>
      <doc name="Configuration Guide" type="markdown" location="docs/configuration.md" />
      <doc name="Environment Setup Guide" type="markdown" location="docs/environment-setup.md" />
      <doc name="Docker Deployment Guide" type="markdown" location="docs/docker-deployment.md" />
      <doc name="Secrets Management Guide" type="markdown" location="docs/secrets-management.md" />
    </docs>
    <code>
      <code name="Configuration Schema" type="typescript" location="src/config/schema.ts" />
      <code name="Configuration Loader" type="typescript" location="src/config/loader.ts" />
      <code name="Environment Validator" type="typescript" location="src/config/validator.ts" />
      <code name="Secrets Manager" type="typescript" location="src/config/secrets.ts" />
      <code name="Dockerfile" type="docker" location="Dockerfile" />
      <code name="Docker Compose Dev" type="yaml" location="docker-compose.dev.yml" />
      <code name="Docker Compose Prod" type="yaml" location="docker-compose.prod.yml" />
      <code name="Health Check Endpoints" type="typescript" location="src/health/index.ts" />
      <code name="Logging Configuration" type="typescript" location="src/logging/config.ts" />
    </code>
    <dependencies>
      <package name="typescript" version="^5.7.0" for="type-safe configuration interfaces" />
      <package name="zod" version="^3.22.0" for="runtime configuration validation" />
      <package name="dotenv" version="^16.3.0" for="environment variable loading" />
      <package name="pino" version="^8.17.0" for="structured JSON logging" />
      <package name="fastify" version="^4.24.0" for="API framework with configuration support" />
      <package name="pg" version="^8.11.0" for="PostgreSQL database connections" />
      <package name="redis" version="^4.6.0" for="Redis caching and sessions" />
      <package name="jsonwebtoken" version="^9.0.0" for="JWT token configuration" />
      <package name="bcrypt" version="^5.1.0" for="password hashing configuration" />
      <package name="helmet" version="^7.1.0" for="security configuration" />
      <package name="cors" version="^2.8.5" for="CORS configuration" />
      <package name="rate-limiter-flexible" version="^4.0.0" for="rate limiting configuration" />
    </dependencies>
  </artifacts>

  <constraints>
    <constraint name="Technology Stack">TypeScript 5.7+ strict mode, Node.js 22 LTS, PostgreSQL 17, Redis 7.x, Fastify 5.x, Vitest 3.x, pnpm 9+</constraint>
    <constraint name="Configuration Pattern">TypeScript interfaces for type-safe configuration with JSON schema validation</constraint>
    <constraint name="Security">Encrypted storage for sensitive data, TLS 1.3 for all communications, secure secret management</constraint>
    <constraint name="Environment Support">Development, staging, and production environments with environment-specific configurations</constraint>
    <constraint name="Docker">Multi-stage Docker builds with health checks and environment-specific compose files</constraint>
    <constraint name="Logging">Structured JSON logging with Pino, correlation ID tracking, and per-environment log levels</constraint>
  </constraints>

  <interfaces>
    <interface name="DatabaseConfig" kind="TypeScript interface" signature="interface DatabaseConfig { host: string; port: number; database: string; username: string; password: string; ssl: boolean; poolSize: number; connectionTimeout: number; }" path="docs/tech-spec-epic-1.md" />
    <interface name="RedisConfig" kind="TypeScript interface" signature="interface RedisConfig { host: string; port: number; password?: string; db: number; keyPrefix: string; }" path="docs/tech-spec-epic-1.md" />
    <interface name="JWTConfig" kind="TypeScript interface" signature="interface JWTConfig { secret: string; expiresIn: string; refreshExpiresIn: string; issuer: string; audience: string; }" path="docs/tech-spec-epic-1.md" />
    <interface name="AppConfig" kind="TypeScript interface" signature="interface AppConfig { env: 'development' | 'staging' | 'production'; port: number; logLevel: 'debug' | 'info' | 'warn' | 'error'; database: DatabaseConfig; redis: RedisConfig; jwt: JWTConfig; cors: { origin: string[]; credentials: boolean; }; rateLimit: { enabled: boolean; windowMs: number; max: number; }; }" path="docs/tech-spec-epic-1.md" />
  </interfaces>
  <tests>
    <standards>Test-Driven Development (TDD) with Red-Green-Refactor cycle using Vitest framework. 100% test coverage required on configuration validation paths. Unit tests for individual configuration modules, integration tests for environment loading, and end-to-end tests for Docker deployments. Mock external services and use test containers for database and Redis testing.</standards>
    <locations>
      <test location="src/config/__tests__/schema.test.ts" for="configuration schema validation" />
      <test location="src/config/__tests__/loader.test.ts" for="environment loading functionality" />
      <test location="src/config/__tests__/validator.test.ts" for="configuration validation logic" />
      <test location="src/config/__tests__/secrets.test.ts" for="secrets management functionality" />
      <test location="src/health/__tests__/index.test.ts" for="health check endpoints" />
      <test location="src/logging/__tests__/config.test.ts" for="logging configuration" />
      <test location="test/integration/config.test.ts" for="end-to-end configuration loading" />
      <test location="test/e2e/docker.test.ts" for="Docker deployment testing" />
    </locations>
    <ideas>
      <test idea="Test configuration schema validation with valid and invalid inputs" acceptanceCriteria="3" />
      <test idea="Test environment variable loading and override behavior" acceptanceCriteria="1" />
      <test idea="Test secrets encryption and decryption functionality" acceptanceCriteria="2" />
      <test idea="Test Docker multi-stage build process" acceptanceCriteria="5" />
      <test idea="Test development environment hot reloading" acceptanceCriteria="6" />
      <test idea="Test structured JSON logging output format" acceptanceCriteria="7" />
      <test idea="Test health check endpoints for all services" acceptanceCriteria="8" />
      <test idea="Test configuration validation on application startup" acceptanceCriteria="3" />
      <test idea="Test environment-specific Docker configurations" acceptanceCriteria="5" />
      <test idea="Test log level configuration per environment" acceptanceCriteria="7" />
      <test idea="Test correlation ID tracking in logs" acceptanceCriteria="7" />
      <test idea="Test readiness and liveness probes" acceptanceCriteria="8" />
    </ideas>
  </tests>
</story-context>